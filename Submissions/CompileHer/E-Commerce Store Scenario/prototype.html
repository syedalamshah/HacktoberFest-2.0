<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BrightCart Backend Prototype UI</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom Variables for Girly Theme */
        :root {
            --primary-fuchsia: #d946ef; /* Fuchsia-600 */
            --secondary-pink: #f472b6;  /* Pink-400 */
            --deep-violet: #8b5cf6;     /* Violet-500 */
            --shadow-fuchsia: #c026d3;  /* Fuchsia-700 for depth */
        }
        
        body {
            /* NEW: Soft Radial Gradient Background */
            background: radial-gradient(circle at top right, #fdf2f8, #f0abfc, #fbcfe8);
            background-attachment: fixed;
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for output area (The color is now bright pink) */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: var(--secondary-pink);
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #fdf2f8; /* Pink-50 */
        }
        
        /* The main button style, now pink/fuchsia with a soft pill shape */
        .api-button {
            transition: all 0.15s ease-in-out;
            border-radius: 9999px; /* Pill shape */
            font-weight: 600;
            box-shadow: 0 5px var(--shadow-fuchsia); /* Deep Fuchsia Shadow */
        }
        .api-button:active {
            box-shadow: 0 0 var(--shadow-fuchsia);
            transform: translateY(5px);
        }
    </style>
</head>
<body class="font-sans min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="text-center mb-10 p-6 rounded-3xl shadow-xl bg-white">
            <h1 class="text-4xl font-extrabold text-fuchsia-600 tracking-tight">
                BrightCart Prototype Controller
            </h1>
            <p class="text-gray-500 mt-2 text-lg">
                Testing Linked Structures, Stacks, Queues, BSTs, and Graphs.
            </p>
        </header>

        <!-- Main Grid Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- API Control Panel (2/3 width on large screens) -->
            <div class="lg:col-span-2 space-y-6">

                <!-- Output Console -->
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-pink-100">
                    <h2 class="text-2xl font-semibold mb-3 text-fuchsia-600 flex items-center">
                        Output Console 
                        <span id="status-message" class="ml-4 text-sm font-medium text-success hidden"></span>
                    </h2>
                    <pre id="output-area" class="bg-gray-800 text-lime-300 p-4 h-64 overflow-y-auto rounded-xl text-sm custom-scrollbar"></pre>
                </div>

                <!-- Milestone 1: Carousel & Linked List -->
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-pink-100">
                    <h2 class="text-2xl font-semibold mb-4 text-fuchsia-600">Milestone 1: Product Carousel (DLL)</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <button onclick="getCarouselState()" class="api-button w-full bg-pink-500 text-white py-3 px-4 hover:bg-pink-400">
                            GET Carousel State
                        </button>
                        <button onclick="validateCarousel()" class="api-button w-full bg-yellow-400 text-gray-900 py-3 px-4 hover:bg-yellow-300">
                            Validate/Repair Cycle
                        </button>
                        <button onclick="createCycle()" class="api-button w-full bg-gray-300 text-gray-800 py-3 px-4 hover:bg-gray-400">
                            Create Test Cycle
                        </button>
                    </div>

                    <div class="bg-pink-50 p-4 rounded-xl space-y-3 border border-pink-200">
                        <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-3">
                            <input type="text" id="product-id-input" placeholder="Product ID (e.g., P999)" class="p-3 border-2 border-pink-300 rounded-lg flex-grow w-full md:w-auto focus:ring-2 focus:ring-fuchsia-400 focus:border-fuchsia-400">
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="is-featured-input" class="rounded-full text-fuchsia-600 border-pink-300 focus:ring-fuchsia-400">
                                <span class="text-sm text-gray-700">Featured?</span>
                            </label>
                            <button onclick="addProductToCarousel()" class="api-button bg-green-500 text-white py-3 px-4 text-sm w-full md:w-auto hover:bg-green-400">Add to Front</button>
                        </div>
                        <div class="flex flex-col md:flex-row items-center space-y-3 md:space-y-0 md:space-x-3">
                            <input type="text" id="remove-product-id" placeholder="Product ID for Action (Remove/Move)" class="p-3 border-2 border-pink-300 rounded-lg flex-grow w-full md:w-auto focus:ring-2 focus:ring-fuchsia-400 focus:border-fuchsia-400">
                            <button onclick="removeProduct()" class="api-button bg-red-500 text-white py-3 px-4 text-sm w-full md:w-auto hover:bg-red-400">Remove Product</button>
                            <button onclick="moveToFront()" class="api-button bg-violet-500 text-white py-3 px-4 text-sm w-full md:w-auto hover:bg-violet-400">Move To Front</button>
                        </div>
                    </div>
                </div>

                <!-- Milestone 2: Shopping Cart (Stack) & Orders (Hybrid Queue) -->
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-pink-100">
                    <h2 class="text-2xl font-semibold mb-4 text-fuchsia-600">Milestone 2: Cart & Order Workflow</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Undo Stack -->
                        <div class="bg-pink-50 p-4 rounded-xl space-y-3 border border-pink-200">
                            <h3 class="text-lg font-medium text-gray-700">Cart Undo Stack</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="action-id-input" value="P402" class="p-3 border-2 border-pink-300 rounded-lg flex-grow" placeholder="Product ID for Action">
                                <select id="action-type-select" class="p-3 border-2 border-pink-300 rounded-lg focus:ring-2 focus:ring-fuchsia-400">
                                    <option value="ADD">ADD</option>
                                    <option value="REMOVE">REMOVE</option>
                                    <option value="QTY_CHANGE">QTY_CHANGE</option>
                                </select>
                            </div>
                            <button onclick="pushCartAction()" class="api-button w-full bg-fuchsia-500 text-white py-3 px-4 hover:bg-fuchsia-400">
                                Push Cart Action
                            </button>
                            <button onclick="undoCartAction()" class="api-button w-full bg-red-500 text-white py-3 px-4 hover:bg-red-400">
                                Undo Last Action
                            </button>
                        </div>

                        <!-- Order Queue -->
                        <div class="bg-pink-50 p-4 rounded-xl space-y-3 border border-pink-200">
                            <h3 class="text-lg font-medium text-gray-700">Order Processing Queue</h3>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="order-id-input" placeholder="Order ID (e.g., O-800)" class="p-3 border-2 border-pink-300 rounded-lg flex-grow focus:ring-2 focus:ring-fuchsia-400">
                                <label class="flex items-center space-x-1">
                                    <input type="checkbox" id="vip-order-input" class="rounded-full text-fuchsia-600 border-pink-300 focus:ring-fuchsia-400">
                                    <span class="text-sm text-gray-700">VIP?</span>
                                </label>
                            </div>
                            <button onclick="enqueueOrder()" class="api-button w-full bg-teal-500 text-white py-3 px-4 hover:bg-teal-400">
                                Enqueue Order
                            </button>
                            <button onclick="processOrder()" class="api-button w-full bg-yellow-500 text-gray-900 py-3 px-4 hover:bg-yellow-400">
                                Process Next Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Milestone 3: Customer & BST/Graph Panel (1/3 width on large screens) -->
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-3xl shadow-xl border border-pink-100">
                    <h2 class="text-2xl font-semibold mb-4 text-fuchsia-600">Milestone 3: Customer DB (BST/Graph)</h2>
                    
                    <div class="bg-pink-50 p-4 rounded-xl space-y-3 border border-pink-200">
                        <h3 class="text-lg font-medium text-gray-700">BST Lookup & Promotion</h3>
                        <input type="number" id="customer-id-input" placeholder="Customer ID (e.g., 500)" class="p-3 border-2 border-pink-300 rounded-lg w-full focus:ring-2 focus:ring-fuchsia-400">
                        <button onclick="findCustomer()" class="api-button w-full bg-violet-600 text-white py-3 px-4 hover:bg-violet-500">
                            Find Customer
                        </button>
                        <button onclick="promoteCustomer()" class="api-button w-full bg-pink-500 text-white py-3 px-4 hover:bg-pink-400">
                            Promote Hot Customer (BST Rotation)
                        </button>
                    </div>

                    <div class="mt-4 bg-pink-50 p-4 rounded-xl space-y-3 border border-pink-200">
                        <h3 class="text-lg font-medium text-gray-700">Recommendations (Graph)</h3>
                        <input type="number" id="rec-customer-id" placeholder="Customer ID" class="p-3 border-2 border-pink-300 rounded-lg w-full focus:ring-2 focus:ring-fuchsia-400">
                        <input type="number" id="rec-k-input" placeholder="Top K (e.g., 3)" value="3" class="p-3 border-2 border-pink-300 rounded-lg w-full focus:ring-2 focus:ring-fuchsia-400">
                        <button onclick="recommendProducts()" class="api-button w-full bg-green-500 text-white py-3 px-4 hover:bg-green-400">
                            Get Recommendations
                        </button>
                    </div>

                    <p class="mt-4 text-sm text-gray-500 text-center">
                        <span class="font-bold">Initial IDs:</span> 300 (Alice), 500 (Bob), 700 (Charlie).
                    </p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Configuration ---
        const BASE_URL = 'http://127.0.0.1:5000';
        // Get the elements outside the event listener to avoid repeated lookups
        const outputArea = document.getElementById('output-area');
        const statusMessage = document.getElementById('status-message');

        // --- Utility Functions ---
        async function apiCall(endpoint, method = 'GET', body = null) {
            outputArea.textContent = 'Loading...';
            statusMessage.classList.add('hidden');
            outputArea.classList.remove('text-red-300', 'text-green-300'); // Clean up text color

            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                };

                if (body) {
                    options.body = JSON.stringify(body);
                }

                // Exponential backoff retry logic (up to 3 attempts)
                let response = null;
                const maxRetries = 3;
                let delay = 1000;
                
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(`${BASE_URL}${endpoint}`, options);
                        if (response.status !== 429) break; // Not a rate limit error, proceed
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    } catch (e) {
                        if (i === maxRetries - 1) throw e;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    }
                }
                
                if (!response) {
                    throw new Error("Failed to fetch after retries.");
                }

                const data = await response.json();

                // Display response status and message
                if (response.ok) {
                    statusMessage.textContent = `Success: ${response.status}`;
                    statusMessage.classList.remove('text-error', 'hidden');
                    statusMessage.classList.add('text-success');
                    outputArea.classList.add('text-green-300');
                } else {
                    statusMessage.textContent = `Error: ${response.status}`;
                    statusMessage.classList.remove('text-success', 'hidden');
                    statusMessage.classList.add('text-error');
                    outputArea.classList.add('text-red-300');
                }
                
                outputArea.textContent = JSON.stringify(data, null, 2);

            } catch (error) {
                statusMessage.textContent = 'Network Error';
                statusMessage.classList.remove('text-success', 'hidden');
                statusMessage.classList.add('text-error');
                outputArea.classList.add('text-red-300');
                outputArea.textContent = `Error connecting to Flask API: ${error.message}. Ensure your Python app is running and CORS is configured.`;
            }
        }
        
        // --- M1: Carousel Operations (Linked List) ---
        // (Functionality remains exactly the same, only error handling changed)
        
        function getCarouselState() {
            apiCall('/carousel');
        }

        function addProductToCarousel() {
            const productId = document.getElementById('product-id-input').value.trim();
            const isFeatured = document.getElementById('is-featured-input').checked;
            if (!productId) {
                displayValidationError("Please enter a Product ID (e.g., P999).");
                return;
            }
            apiCall('/carousel/add', 'POST', { product_id: productId, is_featured: isFeatured });
            document.getElementById('product-id-input').value = '';
            document.getElementById('is-featured-input').checked = false;
        }

        function removeProduct() {
            const productId = document.getElementById('remove-product-id').value.trim();
            if (!productId) {
                displayValidationError("Please enter a Product ID to remove.");
                return;
            }
            apiCall(`/carousel/remove/${productId}`, 'DELETE');
            document.getElementById('remove-product-id').value = '';
        }

        function moveToFront() {
            const productId = document.getElementById('remove-product-id').value.trim();
            if (!productId) {
                displayValidationError("Please enter a Product ID to move to front.");
                return;
            }
            apiCall(`/carousel/move_to_front/${productId}`, 'POST');
            document.getElementById('remove-product-id').value = '';
        }

        function validateCarousel() {
            apiCall('/carousel/validate');
        }

        function createCycle() {
            apiCall('/carousel/validate?create_cycle=true');
        }

        // --- M2: Cart & Order Operations (Stack & Queue) ---

        function pushCartAction() {
            const productId = document.getElementById('action-id-input').value.trim();
            const actionType = document.getElementById('action-type-select').value;
            if (!productId) {
                displayValidationError("Please enter a Product ID for the cart action.");
                return;
            }
            
            // Mock change data for demonstration
            let changeData = {};
            if (actionType === 'QTY_CHANGE') {
                changeData = { old_qty: 1, new_qty: 2 };
            }

            apiCall('/cart/action', 'POST', { 
                action_type: actionType, 
                product_id: productId,
                change_data: changeData
            });
            document.getElementById('action-id-input').value = '';
        }

        function undoCartAction() {
            apiCall('/cart/undo', 'POST');
        }

        function enqueueOrder() {
            const orderId = document.getElementById('order-id-input').value.trim();
            const isVip = document.getElementById('vip-order-input').checked;
            if (!orderId) {
                displayValidationError("Please enter an Order ID.");
                return;
            }
            apiCall('/order/enqueue', 'POST', { order_id: orderId, vip: isVip });
            document.getElementById('order-id-input').value = '';
            document.getElementById('vip-order-input').checked = false;
        }

        function processOrder() {
            apiCall('/order/process', 'POST');
        }

        // --- M3: Customer DB Operations (BST & Graph) ---

        function findCustomer() {
            const customerId = document.getElementById('customer-id-input').value.trim();
            if (!customerId) {
                displayValidationError("Please enter a Customer ID (e.g., 500) to find.");
                return;
            }
            apiCall(`/customer/${customerId}`, 'GET');
        }

        function promoteCustomer() {
            const customerId = document.getElementById('customer-id-input').value.trim();
            if (!customerId) {
                displayValidationError("Please enter a Customer ID to promote.");
                return;
            }
            apiCall(`/customer/promote/${customerId}`, 'POST');
        }

        function recommendProducts() {
            const customerId = document.getElementById('rec-customer-id').value.trim();
            const k = document.getElementById('rec-k-input').value.trim();
            if (!customerId) {
                displayValidationError("Please enter a Customer ID for recommendations.");
                return;
            }
            if (!k || parseInt(k) < 1) {
                displayValidationError("Please enter a valid number (K) for recommendations.");
                return;
            }
            apiCall(`/customer/recommend/${customerId}?k=${k}`, 'GET');
        }

        // --- Keyboard Shortcut (Ctrl+Z) for Undo ---
        document.addEventListener('keydown', (event) => {
            // Check for Ctrl/Cmd + Z
            if ((event.ctrlKey || event.metaKey) && event.key === 'z') {
                event.preventDefault(); // Prevent browser undo behavior
                undoCartAction();
            }
        });
        
        // --- NO ALERT() REPLACEMENT ---
        function displayValidationError(message) {
            statusMessage.textContent = 'Validation Failed';
            statusMessage.classList.remove('text-success', 'hidden');
            statusMessage.classList.add('text-error');
            outputArea.classList.add('text-red-300');
            outputArea.textContent = `Input Error: ${message}`;
        }


        // Initial fetch to show the system state when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Initial call to set up the console with the current carousel state
            getCarouselState();
        });
    </script>

</body>
</html>
